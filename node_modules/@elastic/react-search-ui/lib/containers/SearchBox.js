"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.SearchBoxContainer = void 0;

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _assertThisInitialized2 = _interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _react = require("react");

var _reactSearchUiViews = require("@elastic/react-search-ui-views");

var _2 = require("..");

var _types = require("../types");

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _createSuper(Derived) { var hasNativeReflectConstruct = _isNativeReflectConstruct(); return function _createSuperInternal() { var Super = (0, _getPrototypeOf2.default)(Derived), result; if (hasNativeReflectConstruct) { var NewTarget = (0, _getPrototypeOf2.default)(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return (0, _possibleConstructorReturn2.default)(this, result); }; }

function _isNativeReflectConstruct() { if (typeof Reflect === "undefined" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === "function") return true; try { Date.prototype.toString.call(Reflect.construct(Date, [], function () {})); return true; } catch (e) { return false; } }

var SearchBoxContainer = /*#__PURE__*/function (_Component) {
  (0, _inherits2.default)(SearchBoxContainer, _Component);

  var _super = _createSuper(SearchBoxContainer);

  function SearchBoxContainer() {
    var _this;

    (0, _classCallCheck2.default)(this, SearchBoxContainer);

    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
      args[_key] = arguments[_key];
    }

    _this = _super.call.apply(_super, [this].concat(args));
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "state", {
      isFocused: false
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "handleFocus", function () {
      _this.setState({
        isFocused: true
      });
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "handleBlur", function () {
      _this.setState({
        isFocused: false
      });
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "completeSuggestion", function (searchTerm) {
      var _this$props = _this.props,
          shouldClearFilters = _this$props.shouldClearFilters,
          setSearchTerm = _this$props.setSearchTerm;
      setSearchTerm(searchTerm, {
        shouldClearFilters: shouldClearFilters
      });
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "handleSubmit", function (e) {
      var _this$props2 = _this.props,
          shouldClearFilters = _this$props2.shouldClearFilters,
          searchTerm = _this$props2.searchTerm,
          setSearchTerm = _this$props2.setSearchTerm;
      e.preventDefault();
      setSearchTerm(searchTerm, {
        shouldClearFilters: shouldClearFilters
      });
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "handleChange", function (value) {
      var _this$props3 = _this.props,
          autocompleteMinimumCharacters = _this$props3.autocompleteMinimumCharacters,
          autocompleteResults = _this$props3.autocompleteResults,
          autocompleteSuggestions = _this$props3.autocompleteSuggestions,
          shouldClearFilters = _this$props3.shouldClearFilters,
          searchAsYouType = _this$props3.searchAsYouType,
          setSearchTerm = _this$props3.setSearchTerm,
          debounceLength = _this$props3.debounceLength;

      var options = _objectSpread(_objectSpread({
        autocompleteMinimumCharacters: autocompleteMinimumCharacters
      }, (autocompleteResults || autocompleteSuggestions || searchAsYouType) && {
        debounce: debounceLength || 200
      }), {}, {
        shouldClearFilters: shouldClearFilters,
        refresh: !!searchAsYouType,
        autocompleteResults: !!autocompleteResults,
        autocompleteSuggestions: !!autocompleteSuggestions
      });

      setSearchTerm(value, options);
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "handleNotifyAutocompleteSelected", function (selection) {
      var _this$props4 = _this.props,
          autocompleteResults = _this$props4.autocompleteResults,
          trackAutocompleteClickThrough = _this$props4.trackAutocompleteClickThrough; // Because suggestions don't count as clickthroughs, only
      // results

      if (autocompleteResults && autocompleteResults.shouldTrackClickThrough !== false && !selection.suggestion) {
        var _autocompleteResults$ = autocompleteResults.clickThroughTags,
            clickThroughTags = _autocompleteResults$ === void 0 ? [] : _autocompleteResults$;
        var id = selection.id.raw;
        trackAutocompleteClickThrough(id, clickThroughTags);
      }
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "defaultOnSelectAutocomplete", function (selection) {
      var autocompleteResults = _this.props.autocompleteResults;

      _this.handleNotifyAutocompleteSelected(selection);

      if (!selection.suggestion) {
        var url = selection[autocompleteResults.urlField] ? selection[autocompleteResults.urlField].raw : "";

        if (url) {
          var target = autocompleteResults.linkTarget || "_self";
          window.open(url, target);
        }
      } else {
        _this.completeSuggestion(selection.suggestion);
      }
    });
    return _this;
  }

  (0, _createClass2.default)(SearchBoxContainer, [{
    key: "render",
    value: function render() {
      var _this2 = this;

      var isFocused = this.state.isFocused;
      var _this$props5 = this.props,
          autocompleteMinimumCharacters = _this$props5.autocompleteMinimumCharacters,
          autocompleteResults = _this$props5.autocompleteResults,
          autocompleteSuggestions = _this$props5.autocompleteSuggestions,
          autocompletedResults = _this$props5.autocompletedResults,
          autocompletedSuggestions = _this$props5.autocompletedSuggestions,
          className = _this$props5.className,
          autocompleteView = _this$props5.autocompleteView,
          inputProps = _this$props5.inputProps,
          inputView = _this$props5.inputView,
          onSelectAutocomplete = _this$props5.onSelectAutocomplete,
          onSubmit = _this$props5.onSubmit,
          searchTerm = _this$props5.searchTerm,
          view = _this$props5.view,
          rest = (0, _objectWithoutProperties2.default)(_this$props5, ["autocompleteMinimumCharacters", "autocompleteResults", "autocompleteSuggestions", "autocompletedResults", "autocompletedSuggestions", "className", "autocompleteView", "inputProps", "inputView", "onSelectAutocomplete", "onSubmit", "searchTerm", "view"]);
      var View = view || _reactSearchUiViews.SearchBox;
      var useAutocomplete = (!!autocompleteResults || !!autocompleteSuggestions) && searchTerm.length >= autocompleteMinimumCharacters;
      var autocompletedSuggestionsCount = Object.entries(autocompletedSuggestions // eslint-disable-next-line no-unused-vars
      ).reduce(function (acc, _ref) {
        var _ref2 = (0, _slicedToArray2.default)(_ref, 2),
            _ = _ref2[0],
            value = _ref2[1];

        return acc + value.length;
      }, 0);
      var allAutocompletedItemsCount = autocompletedSuggestionsCount + autocompletedResults.length;
      var handleOnSelectAutocomplete;

      if (onSelectAutocomplete) {
        handleOnSelectAutocomplete = function handleOnSelectAutocomplete(selection) {
          onSelectAutocomplete(selection, {
            notifyAutocompleteSelected: _this2.handleNotifyAutocompleteSelected,
            completeSuggestion: _this2.completeSuggestion,
            autocompleteResults: _this2.props.autocompleteResults
          }, _this2.defaultOnSelectAutocomplete);
        };
      }

      return View(_objectSpread({
        allAutocompletedItemsCount: allAutocompletedItemsCount,
        autocompleteView: autocompleteView,
        autocompleteResults: autocompleteResults,
        autocompleteSuggestions: autocompleteSuggestions,
        autocompletedResults: autocompletedResults,
        autocompletedSuggestions: autocompletedSuggestions,
        className: className,
        autocompletedSuggestionsCount: autocompletedSuggestionsCount,
        completeSuggestion: this.completeSuggestion,
        isFocused: isFocused,
        notifyAutocompleteSelected: this.handleNotifyAutocompleteSelected,
        onChange: function onChange(value) {
          return _this2.handleChange(value);
        },
        onSelectAutocomplete: handleOnSelectAutocomplete || this.defaultOnSelectAutocomplete,
        onSubmit: onSubmit ? function (e) {
          e.preventDefault();
          onSubmit(searchTerm);
        } : this.handleSubmit,
        useAutocomplete: useAutocomplete,
        value: searchTerm,
        inputProps: _objectSpread({
          onFocus: this.handleFocus,
          onBlur: this.handleBlur
        }, inputProps),
        inputView: inputView
      }, rest));
    }
  }]);
  return SearchBoxContainer;
}(_react.Component);

exports.SearchBoxContainer = SearchBoxContainer;
(0, _defineProperty2.default)(SearchBoxContainer, "propTypes", {
  // Props
  autocompleteMinimumCharacters: _propTypes.default.number,
  autocompleteResults: _propTypes.default.oneOfType([_propTypes.default.bool, _propTypes.default.shape({
    clickThroughTags: _propTypes.default.arrayOf(_propTypes.default.string),
    linkTarget: _propTypes.default.string,
    sectionTitle: _propTypes.default.string,
    shouldTrackClickThrough: _propTypes.default.bool,
    titleField: _propTypes.default.string.isRequired,
    urlField: _propTypes.default.string.isRequired
  })]),
  autocompleteSuggestions: _propTypes.default.oneOfType([_propTypes.default.bool, _propTypes.default.exact({
    sectionTitle: _propTypes.default.string
  }), _propTypes.default.objectOf(_propTypes.default.exact({
    sectionTitle: _propTypes.default.string
  }))]),
  autocompleteView: _propTypes.default.func,
  className: _propTypes.default.string,
  shouldClearFilters: _propTypes.default.bool,
  debounceLength: _propTypes.default.number,
  inputProps: _propTypes.default.object,
  inputView: _propTypes.default.func,
  onSelectAutocomplete: _propTypes.default.func,
  onSubmit: _propTypes.default.func,
  searchAsYouType: _propTypes.default.bool,
  view: _propTypes.default.func,
  // State
  autocompletedResults: _propTypes.default.arrayOf(_types.Result).isRequired,
  autocompletedSuggestions: _propTypes.default.objectOf(_propTypes.default.arrayOf(_types.Suggestion)).isRequired,
  searchTerm: _propTypes.default.string.isRequired,
  // Actions
  setSearchTerm: _propTypes.default.func.isRequired,
  trackAutocompleteClickThrough: _propTypes.default.func.isRequired
});
(0, _defineProperty2.default)(SearchBoxContainer, "defaultProps", {
  autocompleteMinimumCharacters: 0,
  shouldClearFilters: true
});

var _default = (0, _2.withSearch)(function (_ref3) {
  var autocompletedResults = _ref3.autocompletedResults,
      autocompletedSuggestions = _ref3.autocompletedSuggestions,
      searchTerm = _ref3.searchTerm,
      setSearchTerm = _ref3.setSearchTerm,
      trackAutocompleteClickThrough = _ref3.trackAutocompleteClickThrough;
  return {
    autocompletedResults: autocompletedResults,
    autocompletedSuggestions: autocompletedSuggestions,
    searchTerm: searchTerm,
    setSearchTerm: setSearchTerm,
    trackAutocompleteClickThrough: trackAutocompleteClickThrough
  };
})(SearchBoxContainer);

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb250YWluZXJzL1NlYXJjaEJveC5qcyJdLCJuYW1lcyI6WyJTZWFyY2hCb3hDb250YWluZXIiLCJpc0ZvY3VzZWQiLCJzZXRTdGF0ZSIsInNlYXJjaFRlcm0iLCJwcm9wcyIsInNob3VsZENsZWFyRmlsdGVycyIsInNldFNlYXJjaFRlcm0iLCJlIiwicHJldmVudERlZmF1bHQiLCJ2YWx1ZSIsImF1dG9jb21wbGV0ZU1pbmltdW1DaGFyYWN0ZXJzIiwiYXV0b2NvbXBsZXRlUmVzdWx0cyIsImF1dG9jb21wbGV0ZVN1Z2dlc3Rpb25zIiwic2VhcmNoQXNZb3VUeXBlIiwiZGVib3VuY2VMZW5ndGgiLCJvcHRpb25zIiwiZGVib3VuY2UiLCJyZWZyZXNoIiwic2VsZWN0aW9uIiwidHJhY2tBdXRvY29tcGxldGVDbGlja1Rocm91Z2giLCJzaG91bGRUcmFja0NsaWNrVGhyb3VnaCIsInN1Z2dlc3Rpb24iLCJjbGlja1Rocm91Z2hUYWdzIiwiaWQiLCJyYXciLCJoYW5kbGVOb3RpZnlBdXRvY29tcGxldGVTZWxlY3RlZCIsInVybCIsInVybEZpZWxkIiwidGFyZ2V0IiwibGlua1RhcmdldCIsIndpbmRvdyIsIm9wZW4iLCJjb21wbGV0ZVN1Z2dlc3Rpb24iLCJzdGF0ZSIsImF1dG9jb21wbGV0ZWRSZXN1bHRzIiwiYXV0b2NvbXBsZXRlZFN1Z2dlc3Rpb25zIiwiY2xhc3NOYW1lIiwiYXV0b2NvbXBsZXRlVmlldyIsImlucHV0UHJvcHMiLCJpbnB1dFZpZXciLCJvblNlbGVjdEF1dG9jb21wbGV0ZSIsIm9uU3VibWl0IiwidmlldyIsInJlc3QiLCJWaWV3IiwiU2VhcmNoQm94IiwidXNlQXV0b2NvbXBsZXRlIiwibGVuZ3RoIiwiYXV0b2NvbXBsZXRlZFN1Z2dlc3Rpb25zQ291bnQiLCJPYmplY3QiLCJlbnRyaWVzIiwicmVkdWNlIiwiYWNjIiwiXyIsImFsbEF1dG9jb21wbGV0ZWRJdGVtc0NvdW50IiwiaGFuZGxlT25TZWxlY3RBdXRvY29tcGxldGUiLCJub3RpZnlBdXRvY29tcGxldGVTZWxlY3RlZCIsImRlZmF1bHRPblNlbGVjdEF1dG9jb21wbGV0ZSIsIm9uQ2hhbmdlIiwiaGFuZGxlQ2hhbmdlIiwiaGFuZGxlU3VibWl0Iiwib25Gb2N1cyIsImhhbmRsZUZvY3VzIiwib25CbHVyIiwiaGFuZGxlQmx1ciIsIkNvbXBvbmVudCIsIlByb3BUeXBlcyIsIm51bWJlciIsIm9uZU9mVHlwZSIsImJvb2wiLCJzaGFwZSIsImFycmF5T2YiLCJzdHJpbmciLCJzZWN0aW9uVGl0bGUiLCJ0aXRsZUZpZWxkIiwiaXNSZXF1aXJlZCIsImV4YWN0Iiwib2JqZWN0T2YiLCJmdW5jIiwib2JqZWN0IiwiUmVzdWx0IiwiU3VnZ2VzdGlvbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7Ozs7Ozs7Ozs7SUFFYUEsa0I7Ozs7Ozs7Ozs7Ozs7Ozt3RkFtREg7QUFDTkMsTUFBQUEsU0FBUyxFQUFFO0FBREwsSzs4RkFJTSxZQUFNO0FBQ2xCLFlBQUtDLFFBQUwsQ0FBYztBQUNaRCxRQUFBQSxTQUFTLEVBQUU7QUFEQyxPQUFkO0FBR0QsSzs2RkFFWSxZQUFNO0FBQ2pCLFlBQUtDLFFBQUwsQ0FBYztBQUNaRCxRQUFBQSxTQUFTLEVBQUU7QUFEQyxPQUFkO0FBR0QsSztxR0FFb0IsVUFBQUUsVUFBVSxFQUFJO0FBQUEsd0JBQ2EsTUFBS0MsS0FEbEI7QUFBQSxVQUN6QkMsa0JBRHlCLGVBQ3pCQSxrQkFEeUI7QUFBQSxVQUNMQyxhQURLLGVBQ0xBLGFBREs7QUFFakNBLE1BQUFBLGFBQWEsQ0FBQ0gsVUFBRCxFQUFhO0FBQ3hCRSxRQUFBQSxrQkFBa0IsRUFBbEJBO0FBRHdCLE9BQWIsQ0FBYjtBQUdELEs7K0ZBRWMsVUFBQUUsQ0FBQyxFQUFJO0FBQUEseUJBQ3dDLE1BQUtILEtBRDdDO0FBQUEsVUFDVkMsa0JBRFUsZ0JBQ1ZBLGtCQURVO0FBQUEsVUFDVUYsVUFEVixnQkFDVUEs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RUEsNkJBTEY7QUFBQSxTQU1PO0FBQ0xlLElBQUFBLG9CQUFvQixFQUFwQkEsb0JBREs7QUFFTEMsSUFBQUEsd0JBQXdCLEVBQXhCQSx3QkFGSztBQUdMaEMsSUFBQUEsVUFBVSxFQUFWQSxVQUhLO0FBSUxHLElBQUFBLGFBQWEsRUFBYkEsYUFKSztBQUtMYSxJQUFBQSw2QkFBNkIsRUFBN0JBO0FBTEssR0FOUDtBQUFBLENBRGEsRUFjYm5CLGtCQWRhLEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUHJvcFR5cGVzIGZyb20gXCJwcm9wLXR5cGVzXCI7XG5pbXBvcnQgeyBDb21wb25lbnQgfSBmcm9tIFwicmVhY3RcIjtcbmltcG9ydCB7IFNlYXJjaEJveCB9IGZyb20gXCJAZWxhc3RpYy9yZWFjdC1zZWFyY2gtdWktdmlld3NcIjtcblxuaW1wb3J0IHsgd2l0aFNlYXJjaCB9IGZyb20gXCIuLlwiO1xuaW1wb3J0IHsgUmVzdWx0LCBTdWdnZXN0aW9uIH0gZnJvbSBcIi4uL3R5cGVzXCI7XG5cbmV4cG9ydCBjbGFzcyBTZWFyY2hCb3hDb250YWluZXIgZXh0ZW5kcyBDb21wb25lbnQge1xuICBzdGF0aWMgcHJvcFR5cGVzID0ge1xuICAgIC8vIFByb3BzXG4gICAgYXV0b2NvbXBsZXRlTWluaW11bUNoYXJhY3RlcnM6IFByb3BUeXBlcy5udW1iZXIsXG4gICAgYXV0b2NvbXBsZXRlUmVzdWx0czogUHJvcFR5cGVzLm9uZU9mVHlwZShbXG4gICAgICBQcm9wVHlwZXMuYm9vbCxcbiAgICAgIFByb3BUeXBlcy5zaGFwZSh7XG4gICAgICAgIGNsaWNrVGhyb3VnaFRhZ3M6IFByb3BUeXBlcy5hcnJheU9mKFByb3BUeXBlcy5zdHJpbmcpLFxuICAgICAgICBsaW5rVGFyZ2V0OiBQcm9wVHlwZXMuc3RyaW5nLFxuICAgICAgICBzZWN0aW9uVGl0bGU6IFByb3BUeXBlcy5zdHJpbmcsXG4gICAgICAgIHNob3VsZFRyYWNrQ2xpY2tUaHJvdWdoOiBQcm9wVHlwZXMuYm9vbCxcbiAgICAgICAgdGl0bGVGaWVsZDogUHJvcFR5cGVzLnN0cmluZy5pc1JlcXVpcmVkLFxuICAgICAgICB1cmxGaWVsZDogUHJvcFR5cGVzLnN0cmluZy5pc1JlcXVpcmVkXG4gICAgICB9KVxuICAgIF0pLFxuICAgIGF1dG9jb21wbGV0ZVN1Z2dlc3Rpb25zOiBQcm9wVHlwZXMub25lT2ZUeXBlKFtcbiAgICAgIFByb3BUeXBlcy5ib29sLFxuICAgICAgUHJvcFR5cGVzLmV4YWN0KHtcbiAgICAgICAgc2VjdGlvblRpdGxlOiBQcm9wVHlwZXMuc3RyaW5nXG4gICAgICB9KSxcbiAgICAgIFByb3BUeXBlcy5vYmplY3RPZihcbiAgICAgICAgUHJvcFR5cGVzLmV4YWN0KHtcbiAgICAgICAgICBzZWN0aW9uVGl0bGU6IFByb3BUeXBlcy5zdHJpbmdcbiAgICAgICAgfSlcbiAgICAgIClcbiAgICBdKSxcbiAgICBhdXRvY29tcGxldGVWaWV3OiBQcm9wVHlwZXMuZnVuYyxcbiAgICBjbGFzc05hbWU6IFByb3BUeXBlcy5zdHJpbmcsXG4gICAgc2hvdWxkQ2xlYXJGaWx0ZXJzOiBQcm9wVHlwZXMuYm9vbCxcbiAgICBkZWJvdW5jZUxlbmd0aDogUHJvcFR5cGVzLm51bWJlcixcbiAgICBpbnB1dFByb3BzOiBQcm9wVHlwZXMub2JqZWN0LFxuICAgIGlucHV0VmlldzogUHJvcFR5cGVzLmZ1bmMsXG4gICAgb25TZWxlY3RBdXRvY29tcGxldGU6IFByb3BUeXBlcy5mdW5jLFxuICAgIG9uU3VibWl0OiBQcm9wVHlwZXMuZnVuYyxcbiAgICBzZWFyY2hBc1lvdVR5cGU6IFByb3BUeXBlcy5ib29sLFxuICAgIHZpZXc6IFByb3BUeXBlcy5mdW5jLFxuICAgIC8vIFN0YXRlXG4gICAgYXV0b2NvbXBsZXRlZFJlc3VsdHM6IFByb3BUeXBlcy5hcnJheU9mKFJlc3VsdCkuaXNSZXF1aXJlZCxcbiAgICBhdXRvY29tcGxldGVkU3VnZ2VzdGlvbnM6IFByb3BUeXBlcy5vYmplY3RPZihQcm9wVHlwZXMuYXJyYXlPZihTdWdnZXN0aW9uKSlcbiAgICAgIC5pc1JlcXVpcmVkLFxuICAgIHNlYXJjaFRlcm06IFByb3BUeXBlcy5zdHJpbmcuaXNSZXF1aXJlZCxcbiAgICAvLyBBY3Rpb25zXG4gICAgc2V0U2VhcmNoVGVybTogUHJvcFR5cGVzLmZ1bmMuaXNSZXF1aXJlZCxcbiAgICB0cmFja0F1dG9jb21wbGV0ZUNsaWNrVGhyb3VnaDogUHJvcFR5cGVzLmZ1bmMuaXNSZXF1aXJlZFxuICB9O1xuXG4gIHN0YXRpYyBkZWZhdWx0UHJvcHMgPSB7XG4gICAgYXV0b2NvbXBsZXRlTWluaW11bUNoYXJhY3RlcnM6IDAsXG4gICAgc2hvdWxkQ2xlYXJGaWx0ZXJzOiB0cnVlXG4gIH07XG5cbiAgc3RhdGUgPSB7XG4gICAgaXNGb2N1c2VkOiBmYWxzZVxuICB9O1xuXG4gIGhhbmRsZUZvY3VzID0gKCkgPT4ge1xuICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgaXNGb2N1c2VkOiB0cnVlXG4gICAgfSk7XG4gIH07XG5cbiAgaGFuZGxlQmx1ciA9ICgpID0+IHtcbiAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgIGlzRm9jdXNlZDogZmFsc2VcbiAgICB9KTtcbiAgfTtcblxuICBjb21wbGV0ZVN1Z2dlc3Rpb24gPSBzZWFyY2hUZXJtID0+IHtcbiAgICBjb25zdCB7IHNob3VsZENsZWFyRmlsdGVycywgc2V0U2VhcmNoVGVybSB9ID0gdGhpcy5wcm9wcztcbiAgICBzZXRTZWFyY2hUZXJtKHNlYXJjaFRlcm0sIHtcbiAgICAgIHNob3VsZENsZWFyRmlsdGVyc1xuICAgIH0pO1xuICB9O1xuXG4gIGhhbmRsZVN1Ym1pdCA9IGUgPT4ge1xuICAgIGNvbnN0IHsgc2hvdWxkQ2xlYXJGaWx0ZXJzLCBzZWFyY2hUZXJtLCBzZXRTZWFyY2hUZXJtIH0gPSB0aGlzLnByb3BzO1xuXG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIHNldFNlYXJjaFRlcm0oc2VhcmNoVGVybSwge1xuICAgICAgc2hvdWxkQ2xlYXJGaWx0ZXJzXG4gICAgfSk7XG4gIH07XG5cbiAgaGFuZGxlQ2hhbmdlID0gdmFsdWUgPT4ge1xuICAgIGNvbnN0IHtcbiAgICAgIGF1dG9jb21wbGV0ZU1pbmltdW1DaGFyYWN0ZXJzLFxuICAgICAgYXV0b2NvbXBsZXRlUmVzdWx0cyxcbiAgICAgIGF1dG9jb21wbGV0ZVN1Z2dlc3Rpb25zLFxuICAgICAgc2hvdWxkQ2xlYXJGaWx0ZXJzLFxuICAgICAgc2VhcmNoQXNZb3VUeXBlLFxuICAgICAgc2V0U2VhcmNoVGVybSxcbiAgICAgIGRlYm91bmNlTGVuZ3RoXG4gICAgfSA9IHRoaXMucHJvcHM7XG5cbiAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgYXV0b2NvbXBsZXRlTWluaW11bUNoYXJhY3RlcnMsXG4gICAgICAuLi4oKGF1dG9jb21wbGV0ZVJlc3VsdHMgfHxcbiAgICAgICAgYXV0b2NvbXBsZXRlU3VnZ2VzdGlvbnMgfHxcbiAgICAgICAgc2VhcmNoQXNZb3VUeXBlKSAmJiB7XG4gICAgICAgIGRlYm91bmNlOiBkZWJvdW5jZUxlbmd0aCB8fCAyMDBcbiAgICAgIH0pLFxuICAgICAgc2hvdWxkQ2xlYXJGaWx0ZXJzLFxuICAgICAgcmVmcmVzaDogISFzZWFyY2hBc1lvdVR5cGUsXG4gICAgICBhdXRvY29tcGxldGVSZXN1bHRzOiAhIWF1dG9jb21wbGV0ZVJlc3VsdHMsXG4gICAgICBhdXRvY29tcGxldGVTdWdnZXN0aW9uczogISFhdXRvY29tcGxldGVTdWdnZXN0aW9uc1xuICAgIH07XG5cbiAgICBzZXRTZWFyY2hUZXJtKHZhbHVlLCBvcHRpb25zKTtcbiAgfTtcblxuICBoYW5kbGVOb3RpZnlBdXRvY29tcGxldGVTZWxlY3RlZCA9IHNlbGVjdGlvbiA9PiB7XG4gICAgY29uc3QgeyBhdXRvY29tcGxldGVSZXN1bHRzLCB0cmFja0F1dG9jb21wbGV0ZUNsaWNrVGhyb3VnaCB9ID0gdGhpcy5wcm9wcztcbiAgICAvLyBCZWNhdXNlIHN1Z2dlc3Rpb25zIGRvbid0IGNvdW50IGFzIGNsaWNrdGhyb3VnaHMsIG9ubHlcbiAgICAvLyByZXN1bHRzXG4gICAgaWYgKFxuICAgICAgYXV0b2NvbXBsZXRlUmVzdWx0cyAmJlxuICAgICAgYXV0b2NvbXBsZXRlUmVzdWx0cy5zaG91bGRUcmFja0NsaWNrVGhyb3VnaCAhPT0gZmFsc2UgJiZcbiAgICAgICFzZWxlY3Rpb24uc3VnZ2VzdGlvblxuICAgICkge1xuICAgICAgY29uc3QgeyBjbGlja1Rocm91Z2hUYWdzID0gW10gfSA9IGF1dG9jb21wbGV0ZVJlc3VsdHM7XG4gICAgICBjb25zdCBpZCA9IHNlbGVjdGlvbi5pZC5yYXc7XG4gICAgICB0cmFja0F1dG9jb21wbGV0ZUNsaWNrVGhyb3VnaChpZCwgY2xpY2tUaHJvdWdoVGFncyk7XG4gICAgfVxuICB9O1xuXG4gIGRlZmF1bHRPblNlbGVjdEF1dG9jb21wbGV0ZSA9IHNlbGVjdGlvbiA9PiB7XG4gICAgY29uc3QgeyBhdXRvY29tcGxldGVSZXN1bHRzIH0gPSB0aGlzLnByb3BzO1xuXG4gICAgdGhpcy5oYW5kbGVOb3RpZnlBdXRvY29tcGxldGVTZWxlY3RlZChzZWxlY3Rpb24pO1xuICAgIGlmICghc2VsZWN0aW9uLnN1Z2dlc3Rpb24pIHtcbiAgICAgIGNvbnN0IHVybCA9IHNlbGVjdGlvblthdXRvY29tcGxldGVSZXN1bHRzLnVybEZpZWxkXVxuICAgICAgICA/IHNlbGVjdGlvblthdXRvY29tcGxldGVSZXN1bHRzLnVybEZpZWxkXS5yYXdcbiAgICAgICAgOiBcIlwiO1xuICAgICAgaWYgKHVybCkge1xuICAgICAgICBjb25zdCB0YXJnZXQgPSBhdXRvY29tcGxldGVSZXN1bHRzLmxpbmtUYXJnZXQgfHwgXCJfc2VsZlwiO1xuICAgICAgICB3aW5kb3cub3Blbih1cmwsIHRhcmdldCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuY29tcGxldGVTdWdnZXN0aW9uKHNlbGVjdGlvbi5zdWdnZXN0aW9uKTtcbiAgICB9XG4gIH07XG5cbiAgcmVuZGVyKCkge1xuICAgIGNvbnN0IHsgaXNGb2N1c2VkIH0gPSB0aGlzLnN0YXRlO1xuICAgIGNvbnN0IHtcbiAgICAgIGF1dG9jb21wbGV0ZU1pbmltdW1DaGFyYWN0ZXJzLFxuICAgICAgYXV0b2NvbXBsZXRlUmVzdWx0cyxcbiAgICAgIGF1dG9jb21wbGV0ZVN1Z2dlc3Rpb25zLFxuICAgICAgYXV0b2NvbXBsZXRlZFJlc3VsdHMsXG4gICAgICBhdXRvY29tcGxldGVkU3VnZ2VzdGlvbnMsXG4gICAgICBjbGFzc05hbWUsXG4gICAgICBhdXRvY29tcGxldGVWaWV3LFxuICAgICAgaW5wdXRQcm9wcyxcbiAgICAgIGlucHV0VmlldyxcbiAgICAgIG9uU2VsZWN0QXV0b2NvbXBsZXRlLFxuICAgICAgb25TdWJtaXQsXG4gICAgICBzZWFyY2hUZXJtLFxuICAgICAgdmlldyxcbiAgICAgIC4uLnJlc3RcbiAgICB9ID0gdGhpcy5wcm9wcztcblxuICAgIGNvbnN0IFZpZXcgPSB2aWV3IHx8IFNlYXJjaEJveDtcbiAgICBjb25zdCB1c2VBdXRvY29tcGxldGUgPVxuICAgICAgKCEhYXV0b2NvbXBsZXRlUmVzdWx0cyB8fCAhIWF1dG9jb21wbGV0ZVN1Z2dlc3Rpb25zKSAmJlxuICAgICAgc2VhcmNoVGVybS5sZW5ndGggPj0gYXV0b2NvbXBsZXRlTWluaW11bUNoYXJhY3RlcnM7XG4gICAgY29uc3QgYXV0b2NvbXBsZXRlZFN1Z2dlc3Rpb25zQ291bnQgPSBPYmplY3QuZW50cmllcyhcbiAgICAgIGF1dG9jb21wbGV0ZWRTdWdnZXN0aW9uc1xuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXVudXNlZC12YXJzXG4gICAgKS5yZWR1Y2UoKGFjYywgW18sIHZhbHVlXSkgPT4gYWNjICsgdmFsdWUubGVuZ3RoLCAwKTtcbiAgICBjb25zdCBhbGxBdXRvY29tcGxldGVkSXRlbXNDb3VudCA9XG4gICAgICBhdXRvY29tcGxldGVkU3VnZ2VzdGlvbnNDb3VudCArIGF1dG9jb21wbGV0ZWRSZXN1bHRzLmxlbmd0aDtcblxuICAgIGxldCBoYW5kbGVPblNlbGVjdEF1dG9jb21wbGV0ZTtcbiAgICBpZiAob25TZWxlY3RBdXRvY29tcGxldGUpIHtcbiAgICAgIGhhbmRsZU9uU2VsZWN0QXV0b2NvbXBsZXRlID0gc2VsZWN0aW9uID0+IHtcbiAgICAgICAgb25TZWxlY3RBdXRvY29tcGxldGUoXG4gICAgICAgICAgc2VsZWN0aW9uLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIG5vdGlmeUF1dG9jb21wbGV0ZVNlbGVjdGVkOiB0aGlzLmhhbmRsZU5vdGlmeUF1dG9jb21wbGV0ZVNlbGVjdGVkLFxuICAgICAgICAgICAgY29tcGxldGVTdWdnZXN0aW9uOiB0aGlzLmNvbXBsZXRlU3VnZ2VzdGlvbixcbiAgICAgICAgICAgIGF1dG9jb21wbGV0ZVJlc3VsdHM6IHRoaXMucHJvcHMuYXV0b2NvbXBsZXRlUmVzdWx0c1xuICAgICAgICAgIH0sXG4gICAgICAgICAgdGhpcy5kZWZhdWx0T25TZWxlY3RBdXRvY29tcGxldGVcbiAgICAgICAgKTtcbiAgICAgIH07XG4gICAgfVxuXG4gICAgcmV0dXJuIFZpZXcoe1xuICAgICAgYWxsQXV0b2NvbXBsZXRlZEl0ZW1zQ291bnQ6IGFsbEF1dG9jb21wbGV0ZWRJdGVtc0NvdW50LFxuICAgICAgYXV0b2NvbXBsZXRlVmlldyxcbiAgICAgIGF1dG9jb21wbGV0ZVJlc3VsdHM6IGF1dG9jb21wbGV0ZVJlc3VsdHMsXG4gICAgICBhdXRvY29tcGxldGVTdWdnZXN0aW9uczogYXV0b2NvbXBsZXRlU3VnZ2VzdGlvbnMsXG4gICAgICBhdXRvY29tcGxldGVkUmVzdWx0czogYXV0b2NvbXBsZXRlZFJlc3VsdHMsXG4gICAgICBhdXRvY29tcGxldGVkU3VnZ2VzdGlvbnM6IGF1dG9jb21wbGV0ZWRTdWdnZXN0aW9ucyxcbiAgICAgIGNsYXNzTmFtZSxcbiAgICAgIGF1dG9jb21wbGV0ZWRTdWdnZXN0aW9uc0NvdW50OiBhdXRvY29tcGxldGVkU3VnZ2VzdGlvbnNDb3VudCxcbiAgICAgIGNvbXBsZXRlU3VnZ2VzdGlvbjogdGhpcy5jb21wbGV0ZVN1Z2dlc3Rpb24sXG4gICAgICBpc0ZvY3VzZWQ6IGlzRm9jdXNlZCxcbiAgICAgIG5vdGlmeUF1dG9jb21wbGV0ZVNlbGVjdGVkOiB0aGlzLmhhbmRsZU5vdGlmeUF1dG9jb21wbGV0ZVNlbGVjdGVkLFxuICAgICAgb25DaGFuZ2U6IHZhbHVlID0+IHRoaXMuaGFuZGxlQ2hhbmdlKHZhbHVlKSxcbiAgICAgIG9uU2VsZWN0QXV0b2NvbXBsZXRlOlxuICAgICAgICBoYW5kbGVPblNlbGVjdEF1dG9jb21wbGV0ZSB8fCB0aGlzLmRlZmF1bHRPblNlbGVjdEF1dG9jb21wbGV0ZSxcbiAgICAgIG9uU3VibWl0OiBvblN1Ym1pdFxuICAgICAgICA/IGUgPT4ge1xuICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgb25TdWJtaXQoc2VhcmNoVGVybSk7XG4gICAgICAgICAgfVxuICAgICAgICA6IHRoaXMuaGFuZGxlU3VibWl0LFxuICAgICAgdXNlQXV0b2NvbXBsZXRlOiB1c2VBdXRvY29tcGxldGUsXG4gICAgICB2YWx1ZTogc2VhcmNoVGVybSxcbiAgICAgIGlucHV0UHJvcHM6IHtcbiAgICAgICAgb25Gb2N1czogdGhpcy5oYW5kbGVGb2N1cyxcbiAgICAgICAgb25CbHVyOiB0aGlzLmhhbmRsZUJsdXIsXG4gICAgICAgIC4uLmlucHV0UHJvcHNcbiAgICAgIH0sXG4gICAgICBpbnB1dFZpZXcsXG4gICAgICAuLi5yZXN0XG4gICAgfSk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgd2l0aFNlYXJjaChcbiAgKHtcbiAgICBhdXRvY29tcGxldGVkUmVzdWx0cyxcbiAgICBhdXRvY29tcGxldGVkU3VnZ2VzdGlvbnMsXG4gICAgc2VhcmNoVGVybSxcbiAgICBzZXRTZWFyY2hUZXJtLFxuICAgIHRyYWNrQXV0b2NvbXBsZXRlQ2xpY2tUaHJvdWdoXG4gIH0pID0+ICh7XG4gICAgYXV0b2NvbXBsZXRlZFJlc3VsdHMsXG4gICAgYXV0b2NvbXBsZXRlZFN1Z2dlc3Rpb25zLFxuICAgIHNlYXJjaFRlcm0sXG4gICAgc2V0U2VhcmNoVGVybSxcbiAgICB0cmFja0F1dG9jb21wbGV0ZUNsaWNrVGhyb3VnaFxuICB9KVxuKShTZWFyY2hCb3hDb250YWluZXIpO1xuIl19