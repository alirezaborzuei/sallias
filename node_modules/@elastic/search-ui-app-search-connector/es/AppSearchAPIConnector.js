import _regeneratorRuntime from "@babel/runtime/regenerator";
import _asyncToGenerator from "@babel/runtime/helpers/asyncToGenerator";
import _classCallCheck from "@babel/runtime/helpers/classCallCheck";
import _createClass from "@babel/runtime/helpers/createClass";
import _defineProperty from "@babel/runtime/helpers/defineProperty";
import _objectWithoutProperties from "@babel/runtime/helpers/objectWithoutProperties";

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

import * as ElasticAppSearch from "@elastic/app-search-javascript";
import { version } from "../package.json";
import { adaptResponse } from "./responseAdapter";
import { adaptRequest } from "./requestAdapters";
import buildResponseAdapterOptions from "./buildResponseAdapterOptions"; // The API will error out if empty facets or filters objects
// are sent.

function removeEmptyFacetsAndFilters(options) {
  var facets = options.facets,
      filters = options.filters,
      rest = _objectWithoutProperties(options, ["facets", "filters"]);

  return _objectSpread(_objectSpread(_objectSpread({}, facets && Object.entries(facets).length > 0 && {
    facets: facets
  }), filters && Object.entries(filters).length > 0 && {
    filters: filters
  }), rest);
}

var AppSearchAPIConnector = /*#__PURE__*/function () {
  /**
   * @callback next
   * @param {Object} updatedQueryOptions The options to send to the API
   */

  /**
   * @callback hook
   * @param {Object} queryOptions The options that are about to be sent to the API
   * @param {next} next The options that are about to be sent to the API
   */

  /**
   * @typedef Options
   * @param {string} searchKey Credential found in your App Search Dashboard
   * @param {string} engineName Engine to query, found in your App Search Dashboard
   * @param {string} hostIdentifier Credential found in your App Search Dashboard
   *  Useful when proxying the Swiftype API or developing against a local API server.
   * @param {hook} beforeSearchCall=(queryOptions,next)=>next(queryOptions) A hook to amend query options before the request is sent to the
   *   API in a query on an "onSearch" event.
   * @param {hook} beforeAutocompleteResultsCall=(queryOptions,next)=>next(queryOptions) A hook to amend query options before the request is sent to the
   *   API in a "results" query on an "onAutocomplete" event.
   * @param {hook} beforeAutocompleteSuggestionsCall=(queryOptions,next)=>next(queryOptions) A hook to amend query options before the request is sent to
   * the API in a "suggestions" query on an "onAutocomplete" event.
   * @param {string} endpointBase="" Overrides the base of the Swiftype API endpoint completely.
   */

  /**
   * @param {Options} options
   */
  function AppSearchAPIConnector(_ref) {
    var searchKey = _ref.searchKey,
        engineName = _ref.engineName,
        hostIdentifier = _ref.hostIdentifier,
        _ref$beforeSearchCall = _ref.beforeSearchCall,
        beforeSearchCall = _ref$beforeSearchCall === void 0 ? function (queryOptions, next) {
      return next(queryOptions);
    } : _ref$beforeSearchCall,
        _ref$beforeAutocomple = _ref.beforeAutocompleteResultsCall,
        beforeAutocompleteResultsCall = _ref$beforeAutocomple === void 0 ? function (queryOptions, next) {
      return next(queryOptions);
    } : _ref$beforeAutocomple,
        _ref$beforeAutocomple2 = _ref.beforeAutocompleteSuggestionsCall,
        beforeAutocompleteSuggestionsCall = _ref$beforeAutocomple2 === void 0 ? function (queryOptions, next) {
      return next(queryOptions);
    } : _ref$beforeAutocomple2,
        _ref$endpointBase = _ref.endpointBase,
        endpointBase = _ref$endpointBase === void 0 ? "" : _ref$endpointBase,
        rest = _objectWithoutProperties(_ref, ["searchKey", "engineName", "hostIdentifier", "beforeSearchCall", "beforeAutocompleteResultsCall", "beforeAutocompleteSuggestionsCall", "endpointBase"]);

    _classCallCheck(this, AppSearchAPIConnector);

    if (!engineName || !(hostIdentifier || endpointBase) || !searchKey) {
      throw Error("hostIdentifier or endpointBase, engineName, and searchKey are required");
    }

    this.client = ElasticAppSearch.createClient(_objectSpread(_objectSpread(_objectSpread({}, endpointBase && {
      endpointBase: endpointBase
    }), hostIdentifier && {
      hostIdentifier: hostIdentifier
    }), {}, {
      apiKey: searchKey,
      engineName: engineName,
      additionalHeaders: {
        "x-swiftype-integration": "search-ui",
        "x-swiftype-integration-version": version
      }
    }, rest));
    this.beforeSearchCall = beforeSearchCall;
    this.beforeAutocompleteResultsCall = beforeAutocompleteResultsCall;
    this.beforeAutocompleteSuggestionsCall = beforeAutocompleteSuggestionsCall;
  }

  _createClass(AppSearchAPIConnector, [{
    key: "onResultClick",
    value: function onResultClick(_ref2) {
      var query = _ref2.query,
          documentId = _ref2.documentId,
          requestId = _ref2.requestId,
          _ref2$tags = _ref2.tags,
          tags = _ref2$tags === void 0 ? [] : _ref2$tags;
      tags = tags.concat("results");
      return this.client.click({
        query: query,
        documentId: documentId,
        requestId: requestId,
        tags: tags
      });
    }
  }, {
    key: "onAutocompleteResultClick",
    value: function onAutocompleteResultClick(_ref3) {
      var query = _ref3.query,
          documentId = _ref3.documentId,
          requestId = _ref3.requestId,
          _ref3$tags = _ref3.tags,
          tags = _ref3$tags === void 0 ? [] : _ref3$tags;
      tags = tags.concat("autocomplete");
      return this.client.click({
        query: query,
        documentId: documentId,
        requestId: requestId,
        tags: tags
      });
    }
  }, {
    key: "onSearch",
    value: function () {
      var _onSearch = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(state, queryConfig) {
        var _this = this;

        var current, filters, resultsPerPage, sortDirection, sortField, restOfQueryConfig, _adaptRequest, query, optionsFromState, withQueryConfigOptions, options;

        return _regeneratorRuntime.wrap(function _callee2$(_context2) {
          while (1) {
            switch (_context2.prev = _context2.next) {
              case 0:
                current = queryConfig.current, filters = queryConfig.filters, resultsPerPage = queryConfig.resultsPerPage, sortDirection = queryConfig.sortDirection, sortField = queryConfig.sortField, restOfQueryConfig = _objectWithoutProperties(queryConfig, ["current", "filters", "resultsPerPage", "sortDirection", "sortField"]);
                _adaptRequest = adaptRequest(_objectSpread(_objectSpread(_objectSpread(_objectSpread(_objectSpread(_objectSpread({}, state), current !== undefined && {
                  current: current
                }), filters !== undefined && {
                  filters: filters
                }), resultsPerPage !== undefined && {
                  resultsPerPage: resultsPerPage
                }), sortDirection !== undefined && {
                  sortDirection: sortDirection
                }), sortField !== undefined && {
                  sortField: sortField
                })), query = _adaptRequest.query, optionsFromState = _objectWithoutProperties(_adaptRequest, ["query"]);
                withQueryConfigOptions = _objectSpread(_objectSpread({}, restOfQueryConfig), optionsFromState);
                options = _objectSpread({}, removeEmptyFacetsAndFilters(withQueryConfigOptions));
                return _context2.abrupt("return", this.beforeSearchCall(options, /*#__PURE__*/function () {
                  var _ref4 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(newOptions) {
                    var response;
                    return _regeneratorRuntime.wrap(function _callee$(_context) {
                      while (1) {
                        switch (_context.prev = _context.next) {
                          case 0:
                            _context.next = 2;
                            return _this.client.search(query, newOptions);

                          case 2:
                            response = _context.sent;
                            return _context.abrupt("return", adaptResponse(response, buildResponseAdapterOptions(queryConfig)));

                          case 4:
                          case "end":
                            return _context.stop();
                        }
                      }
                    }, _callee);
                  }));

                  return function (_x3) {
                    return _ref4.apply(this, arguments);
                  };
                }()));

              case 5:
              case "end":
                return _context2.stop();
            }
          }
        }, _callee2, this);
      }));

      function onSearch(_x, _x2) {
        return _onSearch.apply(this, arguments);
      }

      return onSearch;
    }()
  }, {
    key: "onAutocomplete",
    value: function () {
      var _onAutocomplete = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3(_ref5, queryConfig) {
        var _this2 = this;

        var searchTerm, autocompletedState, promises, _queryConfig$results, current, filters, resultsPerPage, sortDirection, sortField, restOfQueryConfig, _adaptRequest2, query, optionsFromState, withQueryConfigOptions, options, _options;

        return _regeneratorRuntime.wrap(function _callee3$(_context3) {
          while (1) {
            switch (_context3.prev = _context3.next) {
              case 0:
                searchTerm = _ref5.searchTerm;
                autocompletedState = {};
                promises = [];

                if (queryConfig.results) {
                  _queryConfig$results = queryConfig.results, current = _queryConfig$results.current, filters = _queryConfig$results.filters, resultsPerPage = _queryConfig$results.resultsPerPage, sortDirection = _queryConfig$results.sortDirection, sortField = _queryConfig$results.sortField, restOfQueryConfig = _objectWithoutProperties(_queryConfig$results, ["current", "filters", "resultsPerPage", "sortDirection", "sortField"]);
                  _adaptRequest2 = adaptRequest({
                    current: current,
                    searchTerm: searchTerm,
                    filters: filters,
                    resultsPerPage: resultsPerPage,
                    sortDirection: sortDirection,
                    sortField: sortField
                  }), query = _adaptRequest2.query, optionsFromState = _objectWithoutProperties(_adaptRequest2, ["query"]);
                  withQueryConfigOptions = _objectSpread(_objectSpread({}, restOfQueryConfig), optionsFromState);
                  options = removeEmptyFacetsAndFilters(withQueryConfigOptions);
                  promises.push(this.beforeAutocompleteResultsCall(options, function (newOptions) {
                    return _this2.client.search(query, newOptions).then(function (response) {
                      autocompletedState.autocompletedResults = adaptResponse(response).results;
                      autocompletedState.autocompletedResultsRequestId = response.info.meta.request_id;
                    });
                  }));
                }

                if (queryConfig.suggestions) {
                  _options = queryConfig.suggestions;
                  promises.push(this.beforeAutocompleteSuggestionsCall(_options, function (newOptions) {
                    return _this2.client.querySuggestion(searchTerm, newOptions).then(function (response) {
                      autocompletedState.autocompletedSuggestions = response.results;
                      autocompletedState.autocompletedSuggestionsRequestId = response.meta.request_id;
                    });
                  }));
                }

                _context3.next = 7;
                return Promise.all(promises);

              case 7:
                return _context3.abrupt("return", autocompletedState);

              case 8:
              case "end":
                return _context3.stop();
            }
          }
        }, _callee3, this);
      }));

      function onAutocomplete(_x4, _x5) {
        return _onAutocomplete.apply(this, arguments);
      }

      return onAutocomplete;
    }()
  }]);

  return AppSearchAPIConnector;
}();

export default AppSearchAPIConnector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9BcHBTZWFyY2hBUElDb25uZWN0b3IuanMiXSwibmFtZXMiOlsiRWxhc3RpY0FwcFNlYXJjaCIsInZlcnNpb24iLCJhZGFwdFJlc3BvbnNlIiwiYWRhcHRSZXF1ZXN0IiwiYnVpbGRSZXNwb25zZUFkYXB0ZXJPcHRpb25zIiwicmVtb3ZlRW1wdHlGYWNldHNBbmRGaWx0ZXJzIiwib3B0aW9ucyIsImZhY2V0cyIsImZpbHRlcnMiLCJyZXN0IiwiT2JqZWN0IiwiZW50cmllcyIsImxlbmd0aCIsIkFwcFNlYXJjaEFQSUNvbm5lY3RvciIsInNlYXJjaEtleSIsImVuZ2luZU5hbWUiLCJob3N0SWRlbnRpZmllciIsImJlZm9yZVNlYXJjaENhbGwiLCJxdWVyeU9wdGlvbnMiLCJuZXh0IiwiYmVmb3JlQXV0b2NvbXBsZXRlUmVzdWx0c0NhbGwiLCJiZWZvcmVBdXRvY29tcGxldGVTdWdnZXN0aW9uc0NhbGwiLCJlbmRwb2ludEJhc2UiLCJFcnJvciIsImNsaWVudCIsImNyZWF0ZUNsaWVudCIsImFwaUtleSIsImFkZGl0aW9uYWxIZWFkZXJzIiwicXVlcnkiLCJkb2N1bWVudElkIiwicmVxdWVzdElkIiwidGFncyIsImNvbmNhdCIsImNsaWNrIiwic3RhdGUiLCJxdWVyeUNvbmZpZyIsImN1cnJlbnQiLCJyZXN1bHRzUGVyUGFnZSIsInNvcnREaXJlY3Rpb24iLCJzb3J0RmllbGQiLCJyZXN0T2ZRdWVyeUNvbmZpZyIsInVuZGVmaW5lZCIsIm9wdGlvbnNGcm9tU3RhdGUiLCJ3aXRoUXVlcnlDb25maWdPcHRpb25zIiwibmV3T3B0aW9ucyIsInNlYXJjaCIsInJlc3BvbnNlIiwic2VhcmNoVGVybSIsImF1dG9jb21wbGV0ZWRTdGF0ZSIsInByb21pc2VzIiwicmVzdWx0cyIsInB1c2giLCJ0aGVuIiwiYXV0b2NvbXBsZXRlZFJlc3VsdHMiLCJhdXRvY29tcGxldGVkUmVzdWx0c1JlcXVlc3RJZCIsImluZm8iLCJtZXRhIiwicmVxdWVzdF9pZCIsInN1Z2dlc3Rpb25zIiwicXVlcnlTdWdnZXN0aW9uIiwiYXV0b2NvbXBsZXRlZFN1Z2dlc3Rpb25zIiwiYXV0b2NvbXBsZXRlZFN1Z2dlc3Rpb25zUmVxdWVzdElkIiwiUHJvbWlzZSIsImFsbCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQSxPQUFPLEtBQUtBLGdCQUFaLE1BQWtDLGdDQUFsQztBQUNBLFNBQVNDLE9BQVQsUUFBd0IsaUJBQXhCO0FBRUEsU0FBU0MsYUFBVCxRQUE4QixtQkFBOUI7QUFDQSxTQUFTQyxZQUFULFFBQTZCLG1CQUE3QjtBQUNBLE9BQU9DLDJCQUFQLE1BQXdDLCtCQUF4QyxDLENBRUE7QUFDQTs7QUFDQSxTQUFTQywyQkFBVCxDQUFxQ0MsT0FBckMsRUFBOEM7QUFBQSxNQUNwQ0MsTUFEb0MsR0FDUEQsT0FETyxDQUNwQ0MsTUFEb0M7QUFBQSxNQUM1QkMsT0FENEIsR0FDUEYsT0FETyxDQUM1QkUsT0FENEI7QUFBQSxNQUNoQkMsSUFEZ0IsNEJBQ1BILE9BRE87O0FBRTVDLHVEQUNNQyxNQUFNLElBQUlHLE1BQU0sQ0FBQ0MsT0FBUCxDQUFlSixNQUFmLEVBQXVCSyxNQUF2QixHQUFnQyxDQUExQyxJQUErQztBQUFFTCxJQUFBQSxNQUFNLEVBQU5BO0FBQUYsR0FEckQsR0FFTUMsT0FBTyxJQUFJRSxNQUFNLENBQUNDLE9BQVAsQ0FBZUgsT0FBZixFQUF3QkksTUFBeEIsR0FBaUMsQ0FBNUMsSUFBaUQ7QUFBRUosSUFBQUEsT0FBTyxFQUFQQTtBQUFGLEdBRnZELEdBR0tDLElBSEw7QUFLRDs7SUFDS0kscUI7QUFDSjs7Ozs7QUFLQTs7Ozs7O0FBTUE7Ozs7Ozs7Ozs7Ozs7OztBQWVBOzs7QUFHQSx1Q0FVRztBQUFBLFFBVERDLFNBU0MsUUFUREEsU0FTQztBQUFBLFFBUkRDLFVBUUMsUUFSREEsVUFRQztBQUFBLFFBUERDLGNBT0MsUUFQREEsY0FPQztBQUFBLHFDQU5EQyxnQkFNQztBQUFBLFFBTkRBLGdCQU1DLHNDQU5rQixVQUFDQyxZQUFELEVBQWVDLElBQWY7QUFBQSxhQUF3QkEsSUFBSSxDQUFDRCxZQUFELENBQTVCO0FBQUEsS0FNbEI7QUFBQSxxQ0FMREUsNkJBS0M7QUFBQSxRQUxEQSw2QkFLQyxzQ0FMK0IsVUFBQ0YsWUFBRCxFQUFlQyxJQUFmO0FBQUEsYUFBd0JBLElBQUksQ0FBQ0QsWUFBRCxDQUE1QjtBQUFBLEtBSy9CO0FBQUEsc0NBSkRHLGlDQUlDO0FBQUEsUUFKREEsaUNBSUMsdUNBSm1DLFVBQUNILFlBQUQsRUFBZUMsSUFBZjtBQUFBLGFBQ2xDQSxJQUFJLENBQUNELFlBQUQsQ0FEOEI7QUFBQSxLQUluQztBQUFBLGlDQUZESSxZQUVDO0FBQUEsUUFGREEsWUFFQyxrQ0FGYyxFQUVkO0FBQUEsUUFERWIsSUFDRjs7QUFBQTs7QUFDRCxRQUFJLENBQUNNLFVBQUQsSUFBZSxFQUFFQyxjQUFjLElBQUlNLFlBQXBCLENBQWYsSUFBb0QsQ0FBQ1IsU0FBekQsRUFBb0U7QUFDbEUsWUFBTVMsS0FBSyxDQUNULHdFQURTLENBQVg7QUFHRDs7QUFFRCxTQUFLQyxNQUFMLEdBQWN4QixnQkFBZ0IsQ0FBQ3lCLFlBQWpCLCtDQUNSSCxZQUFZLElBQUk7QUFBRUEsTUFBQUEsWUFBWSxFQUFaQTtBQUFGLEtBRFIsR0FFUk4sY0FBYyxJQUFJO0FBQUVBLE1BQUFBLGNBQWMsRUFBRUE7QUFBbEIsS0FGVjtBQUdaVSxNQUFBQSxNQUFNLEVBQUVaLFNBSEk7QUFJWkMsTUFBQUEsVUFBVSxFQUFFQSxVQUpBO0FBS1pZLE1BQUFBLGlCQUFpQixFQUFFO0FBQ2pCLGtDQUEwQixXQURUO0FBRWpCLDBDQUFrQzFCO0FBRmpCO0FBTFAsT0FTVFEsSUFUUyxFQUFkO0FBV0EsU0FBS1EsZ0JBQUwsR0FBd0JBLGdCQUF4QjtBQUNBLFNBQUtHLDZCQUFMLEdBQXFDQSw2QkFBckM7QUFDQSxTQUFLQyxpQ0FBTCxHQUF5Q0EsaUNBQXpDO0FBQ0Q7Ozs7eUNBRTBEO0FBQUEsVUFBM0NPLEtBQTJDLFNBQTNDQSxLQUEyQztBQUFBLFVBQXBDQyxVQUFvQyxTQUFwQ0EsVUFBb0M7QUFBQSxVQUF4QkMsU0FBd0IsU0FBeEJBLFNBQXdCO0FBQUEsNkJBQWJDLElBQWE7QUFBQSxVQUFiQSxJQUFhLDJCQUFOLEVBQU07QUFDekRBLE1BQUFBLElBQUksR0FBR0EsSUFBSSxDQUFDQyxNQUFMLENBQVksU0FBWixDQUFQO0FBQ0EsYUFBTyxLQUFLUixNQUFMLENBQVlTLEtBQVosQ0FBa0I7QUFBRUwsUUFBQUEsS0FBSyxFQUFMQSxLQUFGO0FBQVNDLFFBQUFBLFVBQVUsRUFBVkEsVUFBVDtBQUFxQkMsUUFBQUEsU0FBUyxFQUFUQSxTQUFyQjtBQUFnQ0MsUUFBQUEsSUFBSSxFQUFKQTtBQUFoQyxPQUFsQixDQUFQO0FBQ0Q7OztxREFFc0U7QUFBQSxVQUEzQ0gsS0FBMkMsU0FBM0NBLEtBQTJDO0FBQUEsVUFBcENDLFVBQW9DLFNBQXBDQSxVQUFvQztBQUFBLFVBQXhCQyxTQUF3QixTQUF4QkEsU0FBd0I7QUFBQSw2QkFBYkMsSUFBYTtBQUFBLFVBQWJBLElBQWEsMkJBQU4sRUFBTTtBQUNyRUEsTUFBQUEsSUFBSSxHQUFHQSxJQUFJLENBQUNDLE1BQUwsQ0FBWSxjQUFaLENBQVA7QUFDQSxhQUFPLEtBQUtSLE1BQUwsQ0FBWVMsS0FBWixDQUFrQjtBQUFFTCxRQUFBQSxLQUFLLEVBQUxBLEtBQUY7QUFBU0MsUUFBQUEsVUFBVSxFQUFWQSxVQUFUO0FBQXFCQyxRQUFBQSxTQUFTLEVBQVRBLFNBQXJCO0FBQWdDQyxRQUFBQSxJQUFJLEVBQUpBO0FBQWhDLE9BQWxCLENBQVA7QUFDRDs7OztpR0FFY0csSyxFQUFPQyxXOzs7Ozs7Ozs7QUFFbEJDLGdCQUFBQSxPLEdBTUVELFcsQ0FORkMsTyxFQUNBNUIsTyxHQUtFMkIsVyxDQUxGM0IsTyxFQUNBNkIsYyxHQUlFRixXLENBSkZFLGMsRUFDQUMsYSxHQUdFSCxXLENBSEZHLGEsRUFDQUMsUyxHQUVFSixXLENBRkZJLFMsRUFDR0MsaUIsNEJBQ0RMLFc7Z0NBRW1DaEMsWUFBWSx5RkFDOUMrQixLQUQ4QyxHQUU3Q0UsT0FBTyxLQUFLSyxTQUFaLElBQXlCO0FBQUVMLGtCQUFBQSxPQUFPLEVBQVBBO0FBQUYsaUJBRm9CLEdBRzdDNUIsT0FBTyxLQUFLaUMsU0FBWixJQUF5QjtBQUFFakMsa0JBQUFBLE9BQU8sRUFBUEE7QUFBRixpQkFIb0IsR0FJN0M2QixjQUFjLEtBQUtJLFNBQW5CLElBQWdDO0FBQUVKLGtCQUFBQSxjQUFjLEVBQWRBO0FBQUYsaUJBSmEsR0FLN0NDLGFBQWEsS0FBS0csU0FBbEIsSUFBK0I7QUFBRUgsa0JBQUFBLGFBQWEsRUFBYkE7QUFBRixpQkFMYyxHQU03Q0MsU0FBUyxLQUFLRSxTQUFkLElBQTJCO0FBQUVGLGtCQUFBQSxTQUFTLEVBQVRBO0FBQUYsaUJBTmtCLEUsRUFBM0NYLEssaUJBQUFBLEssRUFBVWMsZ0I7QUFTWkMsZ0JBQUFBLHNCLG1DQUNESCxpQixHQUNBRSxnQjtBQUVDcEMsZ0JBQUFBLE8scUJBQ0RELDJCQUEyQixDQUFDc0Msc0JBQUQsQztrREFHekIsS0FBSzFCLGdCQUFMLENBQXNCWCxPQUF0QjtBQUFBLHVGQUErQixpQkFBTXNDLFVBQU47QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQSxtQ0FDYixLQUFJLENBQUNwQixNQUFMLENBQVlxQixNQUFaLENBQW1CakIsS0FBbkIsRUFBMEJnQixVQUExQixDQURhOztBQUFBO0FBQzlCRSw0QkFBQUEsUUFEOEI7QUFBQSw2REFFN0I1QyxhQUFhLENBQUM0QyxRQUFELEVBQVcxQywyQkFBMkIsQ0FBQytCLFdBQUQsQ0FBdEMsQ0FGZ0I7O0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUEsbUJBQS9COztBQUFBO0FBQUE7QUFBQTtBQUFBLG9COzs7Ozs7Ozs7Ozs7Ozs7Ozs7OzhHQU00QkEsVzs7Ozs7Ozs7O0FBQWRZLGdCQUFBQSxVLFNBQUFBLFU7QUFDZkMsZ0JBQUFBLGtCLEdBQXFCLEU7QUFDdkJDLGdCQUFBQSxRLEdBQVcsRTs7QUFFZixvQkFBSWQsV0FBVyxDQUFDZSxPQUFoQixFQUF5QjtBQUFBLHlDQVFuQmYsV0FBVyxDQUFDZSxPQVJPLEVBRXJCZCxPQUZxQix3QkFFckJBLE9BRnFCLEVBR3JCNUIsT0FIcUIsd0JBR3JCQSxPQUhxQixFQUlyQjZCLGNBSnFCLHdCQUlyQkEsY0FKcUIsRUFLckJDLGFBTHFCLHdCQUtyQkEsYUFMcUIsRUFNckJDLFNBTnFCLHdCQU1yQkEsU0FOcUIsRUFPbEJDLGlCQVBrQjtBQUFBLG1DQVVnQnJDLFlBQVksQ0FBQztBQUNsRGlDLG9CQUFBQSxPQUFPLEVBQVBBLE9BRGtEO0FBRWxEVyxvQkFBQUEsVUFBVSxFQUFWQSxVQUZrRDtBQUdsRHZDLG9CQUFBQSxPQUFPLEVBQVBBLE9BSGtEO0FBSWxENkIsb0JBQUFBLGNBQWMsRUFBZEEsY0FKa0Q7QUFLbERDLG9CQUFBQSxhQUFhLEVBQWJBLGFBTGtEO0FBTWxEQyxvQkFBQUEsU0FBUyxFQUFUQTtBQU5rRCxtQkFBRCxDQVY1QixFQVVmWCxLQVZlLGtCQVVmQSxLQVZlLEVBVUxjLGdCQVZLO0FBbUJqQkMsa0JBQUFBLHNCQW5CaUIsbUNBb0JsQkgsaUJBcEJrQixHQXFCbEJFLGdCQXJCa0I7QUF1QmpCcEMsa0JBQUFBLE9BdkJpQixHQXVCUEQsMkJBQTJCLENBQUNzQyxzQkFBRCxDQXZCcEI7QUF3QnZCTSxrQkFBQUEsUUFBUSxDQUFDRSxJQUFULENBQ0UsS0FBSy9CLDZCQUFMLENBQW1DZCxPQUFuQyxFQUE0QyxVQUFBc0MsVUFBVSxFQUFJO0FBQ3hELDJCQUFPLE1BQUksQ0FBQ3BCLE1BQUwsQ0FBWXFCLE1BQVosQ0FBbUJqQixLQUFuQixFQUEwQmdCLFVBQTFCLEVBQXNDUSxJQUF0QyxDQUEyQyxVQUFBTixRQUFRLEVBQUk7QUFDNURFLHNCQUFBQSxrQkFBa0IsQ0FBQ0ssb0JBQW5CLEdBQTBDbkQsYUFBYSxDQUNyRDRDLFFBRHFELENBQWIsQ0FFeENJLE9BRkY7QUFHQUYsc0JBQUFBLGtCQUFrQixDQUFDTSw2QkFBbkIsR0FDRVIsUUFBUSxDQUFDUyxJQUFULENBQWNDLElBQWQsQ0FBbUJDLFVBRHJCO0FBRUQscUJBTk0sQ0FBUDtBQU9ELG1CQVJELENBREY7QUFXRDs7QUFFRCxvQkFBSXRCLFdBQVcsQ0FBQ3VCLFdBQWhCLEVBQTZCO0FBQ3JCcEQsa0JBQUFBLFFBRHFCLEdBQ1g2QixXQUFXLENBQUN1QixXQUREO0FBRzNCVCxrQkFBQUEsUUFBUSxDQUFDRSxJQUFULENBQ0UsS0FBSzlCLGlDQUFMLENBQXVDZixRQUF2QyxFQUFnRCxVQUFBc0MsVUFBVTtBQUFBLDJCQUN4RCxNQUFJLENBQUNwQixNQUFMLENBQVltQyxlQUFaLENBQTRCWixVQUE1QixFQUF3Q0gsVUFBeEMsRUFBb0RRLElBQXBELENBQXlELFVBQUFOLFFBQVEsRUFBSTtBQUNuRUUsc0JBQUFBLGtCQUFrQixDQUFDWSx3QkFBbkIsR0FBOENkLFFBQVEsQ0FBQ0ksT0FBdkQ7QUFDQUYsc0JBQUFBLGtCQUFrQixDQUFDYSxpQ0FBbkIsR0FDRWYsUUFBUSxDQUFDVSxJQUFULENBQWNDLFVBRGhCO0FBRUQscUJBSkQsQ0FEd0Q7QUFBQSxtQkFBMUQsQ0FERjtBQVNEOzs7dUJBRUtLLE9BQU8sQ0FBQ0MsR0FBUixDQUFZZCxRQUFaLEM7OztrREFDQ0Qsa0I7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUlYLGVBQWVuQyxxQkFBZiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIEVsYXN0aWNBcHBTZWFyY2ggZnJvbSBcIkBlbGFzdGljL2FwcC1zZWFyY2gtamF2YXNjcmlwdFwiO1xuaW1wb3J0IHsgdmVyc2lvbiB9IGZyb20gXCIuLi9wYWNrYWdlLmpzb25cIjtcblxuaW1wb3J0IHsgYWRhcHRSZXNwb25zZSB9IGZyb20gXCIuL3Jlc3BvbnNlQWRhcHRlclwiO1xuaW1wb3J0IHsgYWRhcHRSZXF1ZXN0IH0gZnJvbSBcIi4vcmVxdWVzdEFkYXB0ZXJzXCI7XG5pbXBvcnQgYnVpbGRSZXNwb25zZUFkYXB0ZXJPcHRpb25zIGZyb20gXCIuL2J1aWxkUmVzcG9uc2VBZGFwdGVyT3B0aW9uc1wiO1xuXG4vLyBUaGUgQVBJIHdpbGwgZXJyb3Igb3V0IGlmIGVtcHR5IGZhY2V0cyBvciBmaWx0ZXJzIG9iamVjdHNcbi8vIGFyZSBzZW50LlxuZnVuY3Rpb24gcmVtb3ZlRW1wdHlGYWNldHNBbmRGaWx0ZXJzKG9wdGlvbnMpIHtcbiAgY29uc3QgeyBmYWNldHMsIGZpbHRlcnMsIC4uLnJlc3QgfSA9IG9wdGlvbnM7XG4gIHJldHVybiB7XG4gICAgLi4uKGZhY2V0cyAmJiBPYmplY3QuZW50cmllcyhmYWNldHMpLmxlbmd0aCA+IDAgJiYgeyBmYWNldHMgfSksXG4gICAgLi4uKGZpbHRlcnMgJiYgT2JqZWN0LmVudHJpZXMoZmlsdGVycykubGVuZ3RoID4gMCAmJiB7IGZpbHRlcnMgfSksXG4gICAgLi4ucmVzdFxuICB9O1xufVxuY2xhc3MgQXBwU2VhcmNoQVBJQ29ubmVjdG9yIHtcbiAgLyoqXG4gICAqIEBjYWxsYmFjayBuZXh0XG4gICAqIEBwYXJhbSB7T2JqZWN0fSB1cGRhdGVkUXVlcnlPcHRpb25zIFRoZSBvcHRpb25zIHRvIHNlbmQgdG8gdGhlIEFQSVxuICAgKi9cblxuICAvKipcbiAgICogQGNhbGxiYWNrIGhvb2tcbiAgICogQHBhcmFtIHtPYmplY3R9IHF1ZXJ5T3B0aW9ucyBUaGUgb3B0aW9ucyB0aGF0IGFyZSBhYm91dCB0byBiZSBzZW50IHRvIHRoZSBBUElcbiAgICogQHBhcmFtIHtuZXh0fSBuZXh0IFRoZSBvcHRpb25zIHRoYXQgYXJlIGFib3V0IHRvIGJlIHNlbnQgdG8gdGhlIEFQSVxuICAgKi9cblxuICAvKipcbiAgICogQHR5cGVkZWYgT3B0aW9uc1xuICAgKiBAcGFyYW0ge3N0cmluZ30gc2VhcmNoS2V5IENyZWRlbnRpYWwgZm91bmQgaW4geW91ciBBcHAgU2VhcmNoIERhc2hib2FyZFxuICAgKiBAcGFyYW0ge3N0cmluZ30gZW5naW5lTmFtZSBFbmdpbmUgdG8gcXVlcnksIGZvdW5kIGluIHlvdXIgQXBwIFNlYXJjaCBEYXNoYm9hcmRcbiAgICogQHBhcmFtIHtzdHJpbmd9IGhvc3RJZGVudGlmaWVyIENyZWRlbnRpYWwgZm91bmQgaW4geW91ciBBcHAgU2VhcmNoIERhc2hib2FyZFxuICAgKiAgVXNlZnVsIHdoZW4gcHJveHlpbmcgdGhlIFN3aWZ0eXBlIEFQSSBvciBkZXZlbG9waW5nIGFnYWluc3QgYSBsb2NhbCBBUEkgc2VydmVyLlxuICAgKiBAcGFyYW0ge2hvb2t9IGJlZm9yZVNlYXJjaENhbGw9KHF1ZXJ5T3B0aW9ucyxuZXh0KT0+bmV4dChxdWVyeU9wdGlvbnMpIEEgaG9vayB0byBhbWVuZCBxdWVyeSBvcHRpb25zIGJlZm9yZSB0aGUgcmVxdWVzdCBpcyBzZW50IHRvIHRoZVxuICAgKiAgIEFQSSBpbiBhIHF1ZXJ5IG9uIGFuIFwib25TZWFyY2hcIiBldmVudC5cbiAgICogQHBhcmFtIHtob29rfSBiZWZvcmVBdXRvY29tcGxldGVSZXN1bHRzQ2FsbD0ocXVlcnlPcHRpb25zLG5leHQpPT5uZXh0KHF1ZXJ5T3B0aW9ucykgQSBob29rIHRvIGFtZW5kIHF1ZXJ5IG9wdGlvbnMgYmVmb3JlIHRoZSByZXF1ZXN0IGlzIHNlbnQgdG8gdGhlXG4gICAqICAgQVBJIGluIGEgXCJyZXN1bHRzXCIgcXVlcnkgb24gYW4gXCJvbkF1dG9jb21wbGV0ZVwiIGV2ZW50LlxuICAgKiBAcGFyYW0ge2hvb2t9IGJlZm9yZUF1dG9jb21wbGV0ZVN1Z2dlc3Rpb25zQ2FsbD0ocXVlcnlPcHRpb25zLG5leHQpPT5uZXh0KHF1ZXJ5T3B0aW9ucykgQSBob29rIHRvIGFtZW5kIHF1ZXJ5IG9wdGlvbnMgYmVmb3JlIHRoZSByZXF1ZXN0IGlzIHNlbnQgdG9cbiAgICogdGhlIEFQSSBpbiBhIFwic3VnZ2VzdGlvbnNcIiBxdWVyeSBvbiBhbiBcIm9uQXV0b2NvbXBsZXRlXCIgZXZlbnQuXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBlbmRwb2ludEJhc2U9XCJcIiBPdmVycmlkZXMgdGhlIGJhc2Ugb2YgdGhlIFN3aWZ0eXBlIEFQSSBlbmRwb2ludCBjb21wbGV0ZWx5LlxuICAgKi9cblxuICAvKipcbiAgICogQHBhcmFtIHtPcHRpb25zfSBvcHRpb25zXG4gICAqL1xuICBjb25zdHJ1Y3Rvcih7XG4gICAgc2VhcmNoS2V5LFxuICAgIGVuZ2luZU5hbWUsXG4gICAgaG9zdElkZW50aWZpZXIsXG4gICAgYmVmb3JlU2VhcmNoQ2FsbCA9IChxdWVyeU9wdGlvbnMsIG5leHQpID0+IG5leHQocXVlcnlPcHRpb25zKSxcbiAgICBiZWZvcmVBdXRvY29tcGxldGVSZXN1bHRzQ2FsbCA9IChxdWVyeU9wdGlvbnMsIG5leHQpID0+IG5leHQocXVlcnlPcHRpb25zKSxcbiAgICBiZWZvcmVBdXRvY29tcGxldGVTdWdnZXN0aW9uc0NhbGwgPSAocXVlcnlPcHRpb25zLCBuZXh0KSA9PlxuICAgICAgbmV4dChxdWVyeU9wdGlvbnMpLFxuICAgIGVuZHBvaW50QmFzZSA9IFwiXCIsXG4gICAgLi4ucmVzdFxuICB9KSB7XG4gICAgaWYgKCFlbmdpbmVOYW1lIHx8ICEoaG9zdElkZW50aWZpZXIgfHwgZW5kcG9pbnRCYXNlKSB8fCAhc2VhcmNoS2V5KSB7XG4gICAgICB0aHJvdyBFcnJvcihcbiAgICAgICAgXCJob3N0SWRlbnRpZmllciBvciBlbmRwb2ludEJhc2UsIGVuZ2luZU5hbWUsIGFuZCBzZWFyY2hLZXkgYXJlIHJlcXVpcmVkXCJcbiAgICAgICk7XG4gICAgfVxuXG4gICAgdGhpcy5jbGllbnQgPSBFbGFzdGljQXBwU2VhcmNoLmNyZWF0ZUNsaWVudCh7XG4gICAgICAuLi4oZW5kcG9pbnRCYXNlICYmIHsgZW5kcG9pbnRCYXNlIH0pLCAvL0FkZCBwcm9wZXJ0eSBvbiBjb25kaXRpb25cbiAgICAgIC4uLihob3N0SWRlbnRpZmllciAmJiB7IGhvc3RJZGVudGlmaWVyOiBob3N0SWRlbnRpZmllciB9KSxcbiAgICAgIGFwaUtleTogc2VhcmNoS2V5LFxuICAgICAgZW5naW5lTmFtZTogZW5naW5lTmFtZSxcbiAgICAgIGFkZGl0aW9uYWxIZWFkZXJzOiB7XG4gICAgICAgIFwieC1zd2lmdHlwZS1pbnRlZ3JhdGlvblwiOiBcInNlYXJjaC11aVwiLFxuICAgICAgICBcIngtc3dpZnR5cGUtaW50ZWdyYXRpb24tdmVyc2lvblwiOiB2ZXJzaW9uXG4gICAgICB9LFxuICAgICAgLi4ucmVzdFxuICAgIH0pO1xuICAgIHRoaXMuYmVmb3JlU2VhcmNoQ2FsbCA9IGJlZm9yZVNlYXJjaENhbGw7XG4gICAgdGhpcy5iZWZvcmVBdXRvY29tcGxldGVSZXN1bHRzQ2FsbCA9IGJlZm9yZUF1dG9jb21wbGV0ZVJlc3VsdHNDYWxsO1xuICAgIHRoaXMuYmVmb3JlQXV0b2NvbXBsZXRlU3VnZ2VzdGlvbnNDYWxsID0gYmVmb3JlQXV0b2NvbXBsZXRlU3VnZ2VzdGlvbnNDYWxsO1xuICB9XG5cbiAgb25SZXN1bHRDbGljayh7IHF1ZXJ5LCBkb2N1bWVudElkLCByZXF1ZXN0SWQsIHRhZ3MgPSBbXSB9KSB7XG4gICAgdGFncyA9IHRhZ3MuY29uY2F0KFwicmVzdWx0c1wiKTtcbiAgICByZXR1cm4gdGhpcy5jbGllbnQuY2xpY2soeyBxdWVyeSwgZG9jdW1lbnRJZCwgcmVxdWVzdElkLCB0YWdzIH0pO1xuICB9XG5cbiAgb25BdXRvY29tcGxldGVSZXN1bHRDbGljayh7IHF1ZXJ5LCBkb2N1bWVudElkLCByZXF1ZXN0SWQsIHRhZ3MgPSBbXSB9KSB7XG4gICAgdGFncyA9IHRhZ3MuY29uY2F0KFwiYXV0b2NvbXBsZXRlXCIpO1xuICAgIHJldHVybiB0aGlzLmNsaWVudC5jbGljayh7IHF1ZXJ5LCBkb2N1bWVudElkLCByZXF1ZXN0SWQsIHRhZ3MgfSk7XG4gIH1cblxuICBhc3luYyBvblNlYXJjaChzdGF0ZSwgcXVlcnlDb25maWcpIHtcbiAgICBjb25zdCB7XG4gICAgICBjdXJyZW50LFxuICAgICAgZmlsdGVycyxcbiAgICAgIHJlc3VsdHNQZXJQYWdlLFxuICAgICAgc29ydERpcmVjdGlvbixcbiAgICAgIHNvcnRGaWVsZCxcbiAgICAgIC4uLnJlc3RPZlF1ZXJ5Q29uZmlnXG4gICAgfSA9IHF1ZXJ5Q29uZmlnO1xuXG4gICAgY29uc3QgeyBxdWVyeSwgLi4ub3B0aW9uc0Zyb21TdGF0ZSB9ID0gYWRhcHRSZXF1ZXN0KHtcbiAgICAgIC4uLnN0YXRlLFxuICAgICAgLi4uKGN1cnJlbnQgIT09IHVuZGVmaW5lZCAmJiB7IGN1cnJlbnQgfSksXG4gICAgICAuLi4oZmlsdGVycyAhPT0gdW5kZWZpbmVkICYmIHsgZmlsdGVycyB9KSxcbiAgICAgIC4uLihyZXN1bHRzUGVyUGFnZSAhPT0gdW5kZWZpbmVkICYmIHsgcmVzdWx0c1BlclBhZ2UgfSksXG4gICAgICAuLi4oc29ydERpcmVjdGlvbiAhPT0gdW5kZWZpbmVkICYmIHsgc29ydERpcmVjdGlvbiB9KSxcbiAgICAgIC4uLihzb3J0RmllbGQgIT09IHVuZGVmaW5lZCAmJiB7IHNvcnRGaWVsZCB9KVxuICAgIH0pO1xuXG4gICAgY29uc3Qgd2l0aFF1ZXJ5Q29uZmlnT3B0aW9ucyA9IHtcbiAgICAgIC4uLnJlc3RPZlF1ZXJ5Q29uZmlnLFxuICAgICAgLi4ub3B0aW9uc0Zyb21TdGF0ZVxuICAgIH07XG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgIC4uLnJlbW92ZUVtcHR5RmFjZXRzQW5kRmlsdGVycyh3aXRoUXVlcnlDb25maWdPcHRpb25zKVxuICAgIH07XG5cbiAgICByZXR1cm4gdGhpcy5iZWZvcmVTZWFyY2hDYWxsKG9wdGlvbnMsIGFzeW5jIG5ld09wdGlvbnMgPT4ge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLmNsaWVudC5zZWFyY2gocXVlcnksIG5ld09wdGlvbnMpO1xuICAgICAgcmV0dXJuIGFkYXB0UmVzcG9uc2UocmVzcG9uc2UsIGJ1aWxkUmVzcG9uc2VBZGFwdGVyT3B0aW9ucyhxdWVyeUNvbmZpZykpO1xuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgb25BdXRvY29tcGxldGUoeyBzZWFyY2hUZXJtIH0sIHF1ZXJ5Q29uZmlnKSB7XG4gICAgY29uc3QgYXV0b2NvbXBsZXRlZFN0YXRlID0ge307XG4gICAgbGV0IHByb21pc2VzID0gW107XG5cbiAgICBpZiAocXVlcnlDb25maWcucmVzdWx0cykge1xuICAgICAgY29uc3Qge1xuICAgICAgICBjdXJyZW50LFxuICAgICAgICBmaWx0ZXJzLFxuICAgICAgICByZXN1bHRzUGVyUGFnZSxcbiAgICAgICAgc29ydERpcmVjdGlvbixcbiAgICAgICAgc29ydEZpZWxkLFxuICAgICAgICAuLi5yZXN0T2ZRdWVyeUNvbmZpZ1xuICAgICAgfSA9IHF1ZXJ5Q29uZmlnLnJlc3VsdHM7XG5cbiAgICAgIGNvbnN0IHsgcXVlcnksIC4uLm9wdGlvbnNGcm9tU3RhdGUgfSA9IGFkYXB0UmVxdWVzdCh7XG4gICAgICAgIGN1cnJlbnQsXG4gICAgICAgIHNlYXJjaFRlcm0sXG4gICAgICAgIGZpbHRlcnMsXG4gICAgICAgIHJlc3VsdHNQZXJQYWdlLFxuICAgICAgICBzb3J0RGlyZWN0aW9uLFxuICAgICAgICBzb3J0RmllbGRcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCB3aXRoUXVlcnlDb25maWdPcHRpb25zID0ge1xuICAgICAgICAuLi5yZXN0T2ZRdWVyeUNvbmZpZyxcbiAgICAgICAgLi4ub3B0aW9uc0Zyb21TdGF0ZVxuICAgICAgfTtcbiAgICAgIGNvbnN0IG9wdGlvbnMgPSByZW1vdmVFbXB0eUZhY2V0c0FuZEZpbHRlcnMod2l0aFF1ZXJ5Q29uZmlnT3B0aW9ucyk7XG4gICAgICBwcm9taXNlcy5wdXNoKFxuICAgICAgICB0aGlzLmJlZm9yZUF1dG9jb21wbGV0ZVJlc3VsdHNDYWxsKG9wdGlvbnMsIG5ld09wdGlvbnMgPT4ge1xuICAgICAgICAgIHJldHVybiB0aGlzLmNsaWVudC5zZWFyY2gocXVlcnksIG5ld09wdGlvbnMpLnRoZW4ocmVzcG9uc2UgPT4ge1xuICAgICAgICAgICAgYXV0b2NvbXBsZXRlZFN0YXRlLmF1dG9jb21wbGV0ZWRSZXN1bHRzID0gYWRhcHRSZXNwb25zZShcbiAgICAgICAgICAgICAgcmVzcG9uc2VcbiAgICAgICAgICAgICkucmVzdWx0cztcbiAgICAgICAgICAgIGF1dG9jb21wbGV0ZWRTdGF0ZS5hdXRvY29tcGxldGVkUmVzdWx0c1JlcXVlc3RJZCA9XG4gICAgICAgICAgICAgIHJlc3BvbnNlLmluZm8ubWV0YS5yZXF1ZXN0X2lkO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAocXVlcnlDb25maWcuc3VnZ2VzdGlvbnMpIHtcbiAgICAgIGNvbnN0IG9wdGlvbnMgPSBxdWVyeUNvbmZpZy5zdWdnZXN0aW9ucztcblxuICAgICAgcHJvbWlzZXMucHVzaChcbiAgICAgICAgdGhpcy5iZWZvcmVBdXRvY29tcGxldGVTdWdnZXN0aW9uc0NhbGwob3B0aW9ucywgbmV3T3B0aW9ucyA9PlxuICAgICAgICAgIHRoaXMuY2xpZW50LnF1ZXJ5U3VnZ2VzdGlvbihzZWFyY2hUZXJtLCBuZXdPcHRpb25zKS50aGVuKHJlc3BvbnNlID0+IHtcbiAgICAgICAgICAgIGF1dG9jb21wbGV0ZWRTdGF0ZS5hdXRvY29tcGxldGVkU3VnZ2VzdGlvbnMgPSByZXNwb25zZS5yZXN1bHRzO1xuICAgICAgICAgICAgYXV0b2NvbXBsZXRlZFN0YXRlLmF1dG9jb21wbGV0ZWRTdWdnZXN0aW9uc1JlcXVlc3RJZCA9XG4gICAgICAgICAgICAgIHJlc3BvbnNlLm1ldGEucmVxdWVzdF9pZDtcbiAgICAgICAgICB9KVxuICAgICAgICApXG4gICAgICApO1xuICAgIH1cblxuICAgIGF3YWl0IFByb21pc2UuYWxsKHByb21pc2VzKTtcbiAgICByZXR1cm4gYXV0b2NvbXBsZXRlZFN0YXRlO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IEFwcFNlYXJjaEFQSUNvbm5lY3RvcjtcbiJdfQ==